---
import BaseLayout from "@/layouts/BaseLayout.astro";
import StyledText from "@/components/StyledText";
import ButtonLink from "@/components/ButtonLink";
import {
  siteConfig,
  allSermonData,
  allPreachersData,
  allSeriesData,
} from "@/data/contentCollectionDataFetching";

import { paths } from "@/utils/findPathByType";

import SermonMediaEmbed from "@/components/SermonMediaEmbed";
import Filters from "@/components/DisplayFilters";
import DisplayCards from "@/components/DisplayCards";
import Meta from "@/components/Meta";
import { format as datefnsFormat } from "date-fns";

const latestSermon = allSermonData[0];
const latestSermonDateFormatted = datefnsFormat(
  new Date(
    latestSermon.data.date.valueOf() +
      latestSermon.data.date.getTimezoneOffset() * 60 * 1000,
  ),
  "LLL dd, yyyy",
);

const youtube = siteConfig?.data.general.youtube ?? null;
const youtubeFallbackSearch = youtube
  ? `${youtube}/search?query=${latestSermonDateFormatted}`
  : null;

// Get static paths
export const getStaticPaths = () => {
  return paths.sermons?.path
    ? [{ params: { sermons: paths.sermons.path } }]
    : [];
};
---

<BaseLayout pageTitle={paths.sermons?.label || "Sermons"}>
  <main class="layout-base gap-8 py-8">
    <h1 class="sr-only">Sermons</h1>
    <section class="flex flex-col gap-4">
      <StyledText as="h2" variant="heading">Latest Sermon</StyledText>
      <ButtonLink
        variant="link"
        href={`/${paths.sermons?.path}/${latestSermon.id}`}
        className="hover:text-primary h-fit justify-start p-0"
      >
        <StyledText as="span" variant="subheading">
          {latestSermon.data.title}
        </StyledText>
      </ButtonLink>
      <Meta
        date={latestSermon.data.date}
        scripture={latestSermon.data.scripture}
        preacher={latestSermon.preacher.data.name}
        series={latestSermon.series.data.title}
        linked
        {paths}
        client:load
      />

      <SermonMediaEmbed
        url={latestSermon.data.mediaURL}
        title={latestSermon.data.title}
        youtubeFallbackSearch={youtubeFallbackSearch}
        isCompact={true}
        client:load
      />
    </section>
    <section class="flex flex-col gap-2">
      <Filters
        {allSermonData}
        {allSeriesData}
        {allPreachersData}
        client:only="react"
      />
      <DisplayCards data={allSermonData} paths={paths} client:load />
    </section>
  </main>
</BaseLayout>
