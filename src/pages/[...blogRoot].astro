---
import BaseLayout from "@/layouts/BaseLayout.astro";
import Filter from "@/components/Filters/Filter";
import { CardDisplay } from "@/components/Cards/CardDisplay";
import config from "@/_site-config.json";

import type { GetStaticPaths } from "astro";

// Destructure needed values
const { useBlog, blogLabel } = config.general.blog;

// Prevent manually visiting the path if option set to false
if (!useBlog) {
  return Astro.redirect("/404");
}

// Get static paths
export const getStaticPaths = (async () => {
  return [{ params: { blogRoot: config.general.blog.blogPath } }];
}) satisfies GetStaticPaths;

import { getCollection } from "astro:content";

const allWritings = (await getCollection("writings")).sort(
  (a, b) => b.data.date.valueOf() - a.data.date.valueOf(),
);

const getTags = () => {
  const postsWithTags = allWritings.filter((i) => i.data.tags);
  let tagSet = new Set<string>();

  if (postsWithTags.length > 0) {
    postsWithTags.forEach((post) =>
      post.data.tags?.forEach((t) => tagSet.add(t)),
    );
  }

  return tagSet.size === 0 ? null : [...tagSet].sort();
};
---

<BaseLayout pageTitle={blogLabel || "Blog"}>
  <main class="layout-base gap-8 py-8">
    <section class="flex flex-col gap-2">
      <Filter {allWritings} allTags={getTags()} client:only="react" />
      <CardDisplay data={allWritings} client:load />
    </section>
  </main>
</BaseLayout>
